### 一、分布式事务

#### 1.CAP理论

C-consistency,一致性；

A-availability，可用性；

P-partition tolerance，分区容错性；

##### 1.1.1 一致性

Consistency，用户访问分布式系统中的任意节点，得到的数据必须一致；

当修改了一个节点的数据之后，必须进行节点之间的数据同步，以确保数据的一致性；



##### 1.1.2 可用性

用户访问分布式系统时，读或写操作总能成功；

只能读不能写，或者只能写不能读，或者两者都不能执行，只能说明系统弱可用或者不可用；



##### 1.1.3 分区容错

就是分区，当分布式系统节点之间出现网络故障导致节点之间无法通信的情况：

能够通信的节点会构成一个分区，不能通信的节点也会构成一个分区；



容错，就是即便系统出现了网络分区，整个系统也要程序的对外提供服务；



##### 1.1.4 矛盾

在分布式系统中，由于网络故障的问题，因此网络分区的问题是一定会存在的，而容错性（P）

是硬性指标，所有的分布式系统都要满足；因此需要取舍的就是一致性（C）和可用性（A）了；



#### 1.2 BASE理论：

##### 1.Basically Available（基本可用）：

分布式系统在出现故障时，允许损失部分可用性，即保证核心可用；

##### 2.Soft State（软状态）：

在一定时间内，允许出现中间状态，比如临时的不一致；

##### 3.Eventually Consistent（最终一致性）

虽然无法保证强一致性，但是在软状态结束后，最终达到数据一致；



解决分布式事务的思想：

##### AP思想：

各个子事务分别执行和提交，无需锁定数据。允许出现结果不一致，然后采用弥补措施恢复，

实现最终一致即可。例如AT模式就是如此；

##### CP思想：

各个子事务执行后不要提交，而是等待彼此结果，然后同时提交或回滚。这个过程中锁定资源，不允许

其他人访问，数据处于不可用状态，但能保证一致性，例如XA模式；



#### 1.3 AT模式的脏写问题

在多线程并发访问AT模式的分布式事务时，有可能会出现脏写问题，

解决思路就是引入全局锁的概念。在释放DB锁之前先拿到全局锁。避免同一时刻

有另外一个事务来操作当前的数据；





#### 1.4 TCC模式

TCC模式和AT模式非常相似，每个阶段都是独立事务，不同的是TCC通过人工编码来实现数据恢复。

需要实现三个方法：

try：资源的检测和预留；

confirm：完成资源操作业务，要求try成功confirm一定要能成功；

cancel：预留资源释放，可以理解为try的反向操作；



##### 1.4.2 事务悬挂和空回滚

加入一个分布式事务包含两个分支事务，try阶段，一个分支成功执行，另一个分支事务阻塞；

如果阻塞时间太长，可能导致全局事务超时而触发二阶段的cancel操作。两个分支事务都会执行cancel操作；

但是其中一个分支是未执行try操作的，因此执行cancel操作，未进行try操作的分支也要执行cancel方法，但是

其中不能做任何回滚操作，这就是空回滚；



对于整个空回滚的分支事务，将来try方法阻塞结束依然会执行。但是整个全局事务已经结束了，

因此不会再有confirm或cancel，也就是说这个事务执行了一半，处于悬挂状态，这就是业务悬挂问题；



##### 1.4.3 总结

**TCC的优点是什么：**

1.一阶段完成直接提交事务，释放数据库资源，性能好；

2.相比于AT模型，无需生成快照，无需使用全局锁，性能最强；

3.不依赖数据库事务，而是依赖补偿操作，可以用于非事务型数据库；



**TCC的缺点是什么？**

1.有代码侵入，需要人为编写try，Confirm和cancel接口，比较麻烦；

2.软状态，事务是最终一致；

3.需要考虑Confirm和cancel的失败情况，做好幂等处理、事务悬挂和空回滚处理；





